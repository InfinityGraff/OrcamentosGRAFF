<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manipular Canvas</title>
    
    <link rel="stylesheet" href="./000_Bibliotecas/fontes.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/InfinityGraff/MyBiblioteca@main/CSSBiblioteca.css">

    <script src="https://raw.githack.com/InfinityGraff/MyBiblioteca/main/PreScript.js"    ></script>
    <script src="https://cdn.jsdelivr.net/gh/InfinityGraff/MyBiblioteca@main/Base.js"     ></script>
    <script src="https://cdn.jsdelivr.net/gh/InfinityGraff/MyBiblioteca@main/BaseGRAFF.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/InfinityGraff/MyBiblioteca@main/Templates.js"></script>

    <!--
    <script src=".../MyBiblioteca/PreScript.js"></script> 
    <script src=".../MyBiblioteca/Base.js"     ></script>
    <script src=".../MyBiblioteca/Templates.js"></script>
    -->
    <script src="./000_Bibliotecas/Degrade.js"  ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<style> /*Meu CSS Completo*/
    /*JA FOI*/ input.Error{background:red}
    /*JA FOI*/ select.Error{background:red}

    /*n prec*/ *{transition: all 0.1s ease-in-out}
    /*n prec*/ body{background:#120c16;color: white}
    /*n prec*/ table,button,input,select{margin:4px 0px ; border-radius:20px}
    /*n prec*/ button,input,select{height:20px;font-size:15px}
    /*n prec*/ button{height:30px;background:#ff7300; color:white;border: 2px solid #ffae00; padding: 0px 10px;font-family:Almarose-Medium}
    /*n prec*/ button:hover{transform: scale(1.07)}
    /*n prec*/ button:active{transform: scale(1.05)}
    /*n prec*/ input,select{width:100%;background: #ffffff1a; color: white;font-family:Almarose-Thin}
    /*JA FOI*/ input[type="range"]{width: 50%}
    /*n prec*/ select option{color: #120c16}

    /*JA FOI*/ #DivCnvs{top:80px; width:75%; height:89vh; left: 24.6%;z-index: -5;overflow: scroll;}
    /*JA FOI*/ #Config {top:80px; width:25%; height:100vh; left:  0px; background:#00000046;overflow: scroll;}    
    /*JA FOI*/ #Config > div {background: #50505025;border-radius: 15px;margin: 3px; width: 97%; padding: 20px;}
    /*JA FOI*/ #IconsCofng{top:-10px; right:-10px}
    /*JA FOI*/ #CropedID{top:5px; right:5px}

    /*JA FOI*/ .controls{margin-bottom: 20px}
    /*JA FOI*/ .CanvBox{width: 380px;height: 350px; margin-top: 10px;}
    /*JA FOI*/ .CanvBox canvas {background:#505050;margin:5px}
    /*JA FOI*/ .CanvBox canvas{width: 40%;}
    /*JA FOI*/ label{margin:10px;font-family:Almarose-regular;}
    /*JA FOI*/ .Controles{height: 80px; left: -25px;top: 10px;}

    textarea{font-size: 15px;width: 500px}

    /*JA FOI*/ #FinaisCnvs{left:45%; top:83vh; background:#1f1824f1; height:100px; width:500px; backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px); border-radius: 255px}
    /*JA FOI*/ #FinaisCnvs{border: 2px solid #2e2e2e96}
    /*JA FOI*/ .FilesIMG .imgs{background:#50505023; padding:10px; border-radius:20px; margin:20px 0px}
    /*JA FOI*/ .FilesIMG .DivImgRsut{border:1px solid #ffffff2a; padding:2px; width:50px; height:50px}
    /*JA FOI*/ .FilesIMG img.Larg{width:100%; height:auto}
    /*JA FOI*/ .FilesIMG img.Alt{width:auto; height:100%}
    /*JA FOI*/ .Close{border-radius:5px; background: #ff3232; padding: 1px; width: 16px; height: 16px; opacity: 0;top: 0; right: 0;}
    /*JA FOI*/ .DivImgRsut:hover .Close{opacity: 1;}
    /*JA FOI*/ .Lista{height: 400px; overflow: scroll}
    
    /*JA FOI*/ .td-nome{width: 60%;padding: 0px 2px;}
    /*JA FOI*/ .td-tamn{width: 23%;padding: 0px 2px;}
    /*JA FOI*/ .td-qnt {width: 17%;padding: 0px 2px;}
    /*JA FOI*/  #Rodape{width: 100%; height: 300px;}
    /*JA FOI*/ .Moldura{padding: 2px;border: 1px solid #ff480000}
    /*JA FOI*/ .Moldura.active{border: 1px solid #ff4800}
    /*JA FOI*/ .ConfigTxt canvas{margin: 3px;}
    /*JA FOI*/ .ConfigTxt label{margin:2px}
    /*JA FOI*/ #Inpfiles-001{margin-top: 80px}
    /*n prec*/ hr{border-bottom: 1px solid #57575731; margin: 2px 0px;}
    /*JA FOI*/ .g90{transform: rotate(90deg)}
    /*JA FOI*/ #left{top: 20px; left: 40px; } #leftBtn{top: 50px; left: 70px;}
    /*JA FOI*/ #top{top: 35px; right: -13px;} #topBtn{top: 30px; right: -15px;}
</style>

<style>/*CSS dos SVGs*/
    /*JA FOI*/ svg {cursor: pointer;}
    /*JA FOI*/ .fil0{fill: #ff7300; width: 20px; margin: 5px; height: 20px;}
    /*JA FOI*/ .fil0:hover{transform: scale(1.1);}
    /*JA FOI*/ .fil0:active{transform: scale(1.05);}
    /*JA FOI*/ .fil1{fill:#ff000000; width: 25px;height: 25px;}
    /*JA FOI*/ .Cor1{fill: #ff4800;}
    /*JA FOI*/ .Cor2{fill: purple;}
</style>

<script>
    const Tmnhs = ['PP','P','M','G','GG','XG','XXGG']
    const PrcAryObj=(e,Stg)=>e.find(E=>E.tamn===Stg)?.qnt || 'nada'
    function AtivarDiv(e){Add($(e),'active')}
    function DestivDiv(e){Rmv($(e),'active')}
    const SplitFundo =e=>/costa|c\b/i.test(e)?'C':'F'
    const SplitAvanc=(Stg)=>{
        const partes = Stg.replace('.png','').split(/[\s]*[-_,\t][\s]*/).map(p=>p.trim())
        let [nome,qnt,tamn] = ['','','']
        partes.forEach(e=>{
            if(Tmnhs.includes(e.toUpperCase())){tamn=e.toUpperCase()} 
            else if(/^\d+\s*und?$/i.test(e)){qnt = parseInt(e)}
            else if(/^\d+$/.test(e)){qnt = parseInt(e)} 
            else {nome += (nome ? ' ' : '') + e}
        })
        return {Nome:nome.trim(),Tamn:tamn,Qnt:qnt}
    }
</script>

<body class="Ct">
    
    <div id="Config" class="Cl Fx"> <!--CONFIGURAÇÕES-->

        <div class="Ct w50"><!--NOME DO PEDIDO-->
            <div><input id="NomeCliente" type="text" placeholder="Nome do Pedido"></div>
        </div>

        <div class="Ct w50 Rltv"> <!--CONFIGURAÇÕES DE TAMANHO-->

            <div id="CropedID" class="Ct DivCrop Abslt">
                <div onclick="$('#Crop').click()" id="CropSvg"></div><script>Inn('#CropSvg',IcoCrop('fil0','Opacy'))</script>
                <input id="Crop" type="checkbox" class="none" onchange="Tog('.Croped','Opacy');Read_Canvs()">

            </div>

            <div class="controls">
                <div class="w100">
                    <div class="Ct"><label>Tamanho</label><input type="range" id="size" min="0" max="150" value="50" oninput="Read_Canvs()"></div>
                    <hr>

                    <div class="Controles w100 Rltv" >
                        <div class="Ct"><input type="range" id="left" min="0" max="150" value="50" class="Abslt" oninput="Read_Canvs()"><Button id="leftBtn" class="Abslt" onclick="Centlizar($('#left'))">X</Button></div>
                        <div class="Ct"><input type="range" id="top"  min="0" max="150" value="50" class="Abslt g90" oninput="Read_Canvs()"><Button id="topBtn" class="Abslt" onclick="Centlizar($('#top'))">Y</Button></div>
                    </div>

                    
                </div>
            </div>
            

        </div>

        <div class="ConfigTxt Ct"> <!--CONFIGURAÇÕES DE TEXTO-->
            <div class="Ct w100"><label>Sombra:   </label><input class="w30" id="shadowColor"   type="color" value="#000000"> <input class="w30" id="shadowBlur"   type="number" value="10" oninput="Read_Canvs()"></div>
            <hr class="w100">
            <div class="Ct w100"><label>Contorno: </label><input class="w20" id="outlineColor"  type="color" value="#FFFFFF"> <input id="outlineWidth" type="range" value="2" min="1" max="10" step="0.2" oninput="Read_Canvs()"></div>
            <hr class="w100">
            <div class="Ct w100">
                <div class="Ct"><label class="ppt" id="TypeColor" onclick="InnTogg(this,'Cor:','Degradê:');Tog($$('.inptcolor1,.inptcolor2'),'none')">Degradê:</label></div>
                <div class="Ct w30 none inptcolor1">
                    <input id="FontColor" type="color" value="#000000" oninput="Read_Canvs()">
                </div>
                <div class="Ct inptcolor2">
                    <canvas id="controlCanvas" class="Rd Moldura ClickCanv" width="70" height="70"></canvas>
                    <input class="Opacy noClk" type="color" id="colorPicker1" style="display: none;">
                    <input class="Opacy noClk" type="color" id="colorPicker2" style="display: none;">
                    <div class="Cl">
                        <div class="ClickCanv" id="alignX">X</div> <script>Inn('#alignX',IconAling('fil1','white','white'))</script>
                        <div class="ClickCanv" id="alignY">Y</div> <script>Inn('#alignY',IconAling('fil1 g90','white','white'))</script>
                    </div>
                </div>
                
            </div>
            <hr class="w100">
            <div class="Ct w100"><label>Fonte:</label><select class="w50" id="fontFamily" onchange="CssFont('#fontFamily',this.value);Read_Canvs()"></select><script>load_OptsFnt($('#fontFamily'),KitFonts)</script></div>
        </div>

        <div class="Ct w50"> <!--ABA DE LISTAS-->
            <div class="Cl Rltv">
                <button onclick="Mdal_Area('#Area')">Editar Inputs</button>

                <div id="IconsCofng" class="Ct Abslt">
                    <div id="IcoMais" onclick="AddRow()"></div><script>Inn('#IcoMais',IcoMais('fil0'))</script>
                    <div id="IcoLixo" onclick="Limpar();LimpObj()"></div><script>Inn('#IcoLixo',IcoClen('fil0'))</script>
                </div>

                <table id="Lista-001" class="Lista" class="Cl">
                    <thead class="Cl">
                        <tr class="Ct w100"><th class="td-nome">Nome</th><th class="td-tamn">Tamanho</th><th class="td-qnt">Qnt</th></tr>
                    </thead>
                    <tbody class="Cl">
                        <tr class="Ct w100">
                            <td class="td-nome Ct"><input  class="nome" type="text" placeholder="Nome" oninput="Rmv(this,'Error')" onchange="Read_Obj_Ipt()" onpaste="ColarTudo(this)" autocomplete="off"></td>
                            <td class="td-tamn Ct"><select class="tamn" onchange="Read_Obj_Ipt()"></select><script>load_Opts($('#Lista-001 .td-tamn > select'),['',...Tmnhs])</script></td>
                            <td class="td-qnt Ct"><input   class="qnt"  type="number" placeholder="Qnt" oninput="Rmv(this,'Error')" onchange="Read_Obj_Ipt()" autocomplete="off"></td>
                            <td><div    class="td-Src none"></div></td>
                            <td><div    class="td-Org none"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    
    </div>

    <div id="DivCnvs" class="Ct Fx"> <!--ÁREA DE EXIBIÇÃO CANVAS-->
        <div id="Inpfiles-001" class="w100"></div><script>Inn('#Inpfiles-001',IptFile('#FilesIMG-001 .imgs'))</script>
        <div id="FilesIMG-001" class="w100 FilesIMG Ct"><div class="imgs Ct"></div></div>
        <canvas id="gradientCanvas" width="400" height="400"></canvas>
        <div id="AllCanvas" class="Ct"></div>
        <div id="Rodape"></div>
    </div>

    <div id="FinaisCnvs" class="Ct Fx"> <!--CONFIRMAÇÕES FINAIS-->
        <button onclick="Load_Cnvs('#AllCanvas')">Carregar Canvas</button>
    </div>

    <div id="FModal" class="Ct"> <!--FUNDO MODAL-->
        <div id="Mdal-Area">
            <textarea id="Area" placeholder="Digite aqui..." oninput="ResizeArea(this)" onkeydown="KeyEntr(()=>Read_Obj_Area('#Area'))"></textarea>
        </div>
    </div>

</body>

<script> // Const Padrões pra todos Apps (são coisas que só tem 1 Unica Vez por App) Geralmente usadas pra Encurtar DOM
    const FMdal = $('#FModal')

    document.addEventListener('click',e=>{const Div = e.target
        Rmv('.Moldura','active')
        if(S(Div).Coten('ClickCanv')||Div.closest('.ClickCanv')){AtivarDiv('.Moldura.ClickCanv')}
        else{DestivDiv('.Moldura.ClickCanv')}
    })

    document.addEventListener('keydown',e=>{
        if($('.Moldura.ClickCanv.active')){
            if(e.key==='c'){$('#alignX').click()}
            if(e.key==='e'){$('#alignY').click()}
        }
    })

</script>

<script> // Const Apenas para GABARITO
    const OBJOBJ=[
        [{id:'C_PP'  ,W:'1333',H:'1956'},{id:'F_PP'  ,W:'1333',H:'1899'},],
        [{id:'C_P'   ,W:'1503',H:'2211'},{id:'F_P'   ,W:'1503',H:'2154'},],
        [{id:'C_M'   ,W:'1559',H:'2353'},{id:'F_M'   ,W:'1559',H:'2296'},],
        [{id:'C_G'   ,W:'1701',H:'2466'},{id:'F_G'   ,W:'1701',H:'2381'},],
        [{id:'C_GG'  ,W:'1815',H:'2504'},{id:'F_GG'  ,W:'1815',H:'2468'},],
        [{id:'C_XG'  ,W:'2041',H:'2565'},{id:'F_XG'  ,W:'2041',H:'2560'},],
        [{id:'C_XXGG',W:'2239',H:'2749'},{id:'F_XXGG',W:'2239',H:'2743'},],
    ]

    let ObjCanvs = []
    const ObjFundo = []

</script>

<script> // Funções Pequenas
    function Mdal_Area(e){ShowModal($(FMdal),'#Mdal-Area') ;  $(e).value = '' ; Foco(e)}
    function Centlizar(e){e.value = 50 ; Read_Canvs()}
    function Limpar(){$$('#Lista-001 tbody tr:not(:first-child)').forEach(e=>e.remove()) ; Clen_Alls($('#Lista-001 tbody tr:first-child'))}
    function LimpObj(){ObjCanvs = []}
    function AddRow(){const newRow = $('#Lista-001 tbody tr:last-child').cloneNode(true) ; Clen_Alls(newRow) ; $('#Lista-001 tbody').appendChild(newRow)}
    function Upload(div){$$(`${div} img`).forEach(img=>{
        Insert(Pai(img)).Befor(`<div class="Ct Abslt Close Opacy" onclick="Pai(this).remove();Read_Obj_Img('${div} img')">X</div>`)
        
        if(img.naturalWidth>img.naturalHeight){Add(img,'Larg')}else{Add(img,'Alt')}}) ; Read_Obj_Img(`${div} img`)}
    async function ColarTudo(inpt){
        const valor = await navigator.clipboard.readText()
        if(!valor.match(/\n/g)&& valor.match(/\t/g)){Read_Ipt_Lin(inpt,valor) ; return}
        if(!valor.match(/\n/g)&&!valor.match(/\t/g)){return}
        $('#Area').value = valor ; Read_Obj_Area('#Area',inpt)
    }
</script>

<script>
    // Atualiza Objeto Baseado na Area     // Depois tentar para Sincronizar
    function Read_Obj_Area(Area,inpt){
        ObjCanvs.splice(IdxDe(Avo(inpt)))
        $(Area).value.split('\n').map(match=>{
        const {Nome,Tamn,Qnt} = SplitAvanc(match)
        ObjCanvs.push({qnt:Qnt, tamn:Tamn, nome:Nome,src:'',Orgn:''})
        })
        Read_Ipt_Obj()
    }

    // Atualiza Objetos Baseado nas Imagens (Fundo e Nomes) // Depois tentar Sincronizar
    function Read_Obj_Img(imgs){
        ObjCanvs = []
        const Imgss = $$(imgs).filter(e=>!/fundo/i.test(e.name))
        const Funds = $$(imgs).filter(e=> /fundo/i.test(e.name))
        if(Imgss.length>0){Imgss.map(e=>{
                const {Nome,Qnt,Tamn} = SplitAvanc(e.name)
                ObjCanvs.push({qnt:Qnt,tamn:Tamn,nome:Nome,Orgn:'Imgs',src:e.src})});Read_Ipt_Obj()
        }
        if(Funds.length>0){Funds.map(e=>{ObjFundo.push({lado:SplitFundo(e.name),src:e.src})})}
    }

    // Atualiza Inputs Baseado no Objeto
    function Read_Ipt_Obj(){
        None(FMdal)
        Limpar()
        ObjCanvs.forEach((i,x)=>{
            if(x>0){AddRow()}
            const lastRow = $('#Lista-001 tbody tr:last-child')
            $('.qnt',lastRow).value = i.qnt
            $('.tamn',lastRow).value = i.tamn
            $('.nome',lastRow).value = i.nome
            $('.td-Src',lastRow).innerHTML = i.src
            $('.td-Org',lastRow).innerHTML = i.Orgn
        })
    }

    // Atualiza Inputs Baseado no CntrlV Unico
    function Read_Ipt_Lin(inpt,obj){
        const {Nome,Tamn,Qnt} = SplitAvanc(obj)
        const RowAtual = $('#Lista-001').rows[IdxDe(Avo(inpt))+1]
        $('.qnt',RowAtual).value = Qnt
        $('.tamn',RowAtual).value = Tamn
        $('.nome',RowAtual).value = Nome
        $('.td-Src',RowAtual).innerHTML = ''
        $('.td-Org',RowAtual).innerHTML = ''
        
    }

    // Atualiza Objeto Baseado no Inputs
    function Read_Obj_Ipt(){
        ObjCanvs = []
        $$('#Lista-001 tbody tr').map(e=>{
            const qnt  = $('.qnt',e).value
            const tamn = $('.tamn',e).value
            const nome = $('.nome',e).value
            const src  = $('.td-Src',e).innerHTML
            const org  = $('.td-Org',e).innerHTML

            ObjCanvs.push({qnt:Number(qnt),tamn,nome,src,org})

          //if(qnt&&tamn&&nome){console.log('tem tudo');}else{}
        })
        console.log('Objeto Atualizado',ObjCanvs)
    }

    // dar p Inner nos Input Canvas
    function Load_Cnvs(div){
        if(InptsVazio('#Lista-001 input,#Lista-001 select')){return}      
        Read_Obj_Ipt()
        $(div).innerHTML = ObjCanvs.map((e,x)=>{
            const obj = OBJOBJ.find(arr=>arr[0].id.replace('C_','').replace('F_','')===e.tamn) // Encontra o tamanho correspondente em OBJOBJ
            return `<div class="CanvBox Ct" id="Box${obj[1].id}">
                        <h1 class="H1">${e.qnt} - ${obj[1].id.replace('F_','')}</h1>
                        <div>${e.nome}</div>
                        <div class="Ct">
                            <canvas id="${obj[1].id}${x}" width="${obj[1].W}" height="${obj[1].H}"></canvas>
                            <canvas id="${obj[0].id}${x}" width="${obj[0].W}" height="${obj[0].H}"></canvas>
                        </div>
                        <div class="Ct">
                            <button class="none" onclick="Baixar_Cnvs('${obj[1].id}','${obj[1].id}','${e.qnt}')">Baixar Frente JPG</button>
                            <button class="none" onclick="Baixar_Cnvs('${obj[0].id}','${obj[0].id}','${e.qnt}')">Baixar Costas JPG</button>
                            <button onclick="Baixar_Cnvs('${obj[1].id}${x}','${obj[0].id}${x}','${e.qnt}')">Baixar Gabarito</button>
                        </div>
                        <div class="box-qnt none">${e.qnt} Unidades</div>
                    </div>`
                
                }).join('')
        Read_Canvs()
    }
    
    // Atualizar a Parte Interna do Canvas
    function Read_Canvs(){
        ObjCanvs.forEach(({qnt,tamn,nome,src},x)=>{
            
            const image  = new Image() ; image.src =  src && src !== '' ? src : './Testes/Edson.png'
            const FundoF = new Image() ; FundoF.src =  ObjFundo.some(e=>e.lado==='F') ? ObjFundo.filter(e=>e.lado==='F').map(e=>e.src):'./Fundo.jpg'
            const FundoC = new Image() ; FundoC.src =  ObjFundo.some(e=>e.lado==='C') ? ObjFundo.filter(e=>e.lado==='C').map(e=>e.src):FundoF.src
            const MoldeF = new Image() ; MoldeF.src = `./Moldes/F_${tamn}.png`
            const MoldeC = new Image() ; MoldeC.src = `./Moldes/C_${tamn}.png`

            function drawCanvas(cnvs,ctx,F_C,nome){
                const Crop = $('#Crop').checked
                const cW = cnvs.width, cH = cnvs.height;
                const newW = $('#size').value/100 * cW
                const newH = (newW/image.width) * image.height
                const newL = $('#left').value/100 * cW - (newW/2)
                const newT = $('#top' ).value/100 * cH - (newH/2)
                ctx.clearRect(0,0,cW,cH)
                
                const fundo = F_C === "F" ? FundoF : FundoC
                const [fundoW, fundoH] = [fundo.width, fundo.height]

                if (Crop) {
                    const scale = Math.max(cW / fundoW, cH / fundoH)
                    const cropX = (fundoW * scale - cW) / 2
                    const cropY = (fundoH * scale - cH) / 2
                    ctx.drawImage(fundo, -cropX, -cropY, fundoW * scale, fundoH * scale)
                }else{ctx.drawImage(fundo,0,0,cW,cH)}

                if(F_C==="C"){
                    if(image.src.match(/Edson\.png$/i)){
                        const newCanvas = document.createElement('canvas') ; const newCtx = newCanvas.getContext('2d')
                        newCanvas.width = newW ; newCanvas.height = newH

                        // Ajustar o tamanho da fonte para preencher o canvas
                        let fontSize = 1; // Iniciar com um tamanho de fonte pequeno
                        newCtx.font = `${fontSize}px ${$Vl('#fontFamily')}`;
                        while (newCtx.measureText(nome).width < newW && fontSize < newH){fontSize++ ; newCtx.font = `${fontSize}px ${$Vl('#fontFamily')}`}
                        fontSize--; newCtx.font = `${fontSize}px ${$Vl('#fontFamily')}`

                        ctx.shadowColor = $Vl('#shadowColor')
                        ctx.shadowBlur = $Vl('#shadowBlur')*10

                        const Zoom = 5                     
                        const newGradient = newCtx.createLinearGradient(
                            (GlobDegrade.x1*Zoom),(GlobDegrade.y1* Zoom),
                            (GlobDegrade.x2*Zoom),(GlobDegrade.y2* Zoom))

                        newGradient.addColorStop(0, GlobDegrade.color1)
                        newGradient.addColorStop(1, GlobDegrade.color2)

                        // Aplica o gradiente no novo canvas
                        newCtx.fillStyle = $('#TypeColor').innerHTML ==='Cor:' ? $Vl('#FontColor') : newGradient
                        newCtx.strokeStyle  = $Vl('#outlineColor')
                        newCtx.lineWidth    = $Vl('#outlineWidth')*10
                        newCtx.lineJoin     = 'round'        // Configurar para cantos arredondados
                        newCtx.textBaseline = 'middle'   // Centraliza verticalmente o texto

                        // Desenhar contorno e texto no novo contexto
                        newCtx.save() // Salva o estado atual do contexto
                        newCtx.textAlign = 'center'; // Centraliza horizontalmente
                        newCtx.strokeText(nome,newW/2,newH/2) // Desenhar contorno
                        newCtx.fillText(  nome,newW/2,newH/2)   // Desenhar texto com gradiente
                        newCtx.restore() // Restaura o estado anterior do contexto

                        // Desenhar o novo canvas no contexto original
                        ctx.drawImage(newCanvas, newL, newT, newCanvas.width, newCanvas.height);
                    }else{
                        ctx.drawImage(image,newL,newT,newW,newH)
                    }
                }
                ctx.drawImage(F_C==="F"?MoldeF:MoldeC,0,0,cW,cH)
            }
            Promise.all([
                new Promise(r=>image.onload  =r),
                new Promise(r=>FundoF.onload =r),
                new Promise(r=>FundoC.onload =r),
                new Promise(r=>MoldeF.onload =r),
                new Promise(r=>MoldeC.onload =r),
            ]).then(()=>{
                drawCanvas($(`#F_${tamn}${x}`),$(`#F_${tamn}${x}`).getContext('2d'),'F',nome)
                drawCanvas($(`#C_${tamn}${x}`),$(`#C_${tamn}${x}`).getContext('2d'),'C',nome)
            })
        })
    }


    function JuntarCanvas(C1,C2){
        const c1 = $('#'+C1)
        const c2 = $('#'+C2)
        const space = 10

        const newCanvas = document.createElement('canvas')
        newCanvas.width = c1.width + c2.width + space
        newCanvas.height = Math.max(c1.height, c2.height)

        const ctx = newCanvas.getContext('2d')

        ctx.fillStyle = 'white'
        ctx.fillRect(0, 0, newCanvas.width, newCanvas.height)

        const c1Y = newCanvas.height - c1.height
        const c2Y = newCanvas.height - c2.height

        ctx.drawImage(c1, 0, c1Y)
        ctx.drawImage(c2, c1.width + space, c2Y)

        return newCanvas
    }

    function Nome_Bxar(C1,und){return `${$Vl('#NomeCliente')}_ CAM `+C1.replace('C_','').replace('F_','').replace(/\d/g, "")+`_ ${und} UND.jpg`}

    function Baixar_Cnvs(C1,C2,und){
        console.log(C1,C2)
        if($Vl('#NomeCliente')===''){ alert('Falta Nome do Pedido');return}
        const link = document.createElement('a')
        link.href = JuntarCanvas(C1,C2).toDataURL('image/jpeg')
        link.download = Nome_Bxar(C1,und)
        link.click()
    }

    function saveCanvasAsZip(){
        if($Vl('#NomeCliente')===''){alert('Falta Nome do Pedido');return}
        const zip = new JSZip()
        $$('#AllCanvas .CanvBox').forEach(box=>{
            const Canvas = $$(`#${box.id} canvas`)
            const und = $(`#${box.id} .box-qnt`)
            const imgData = JuntarCanvas(Canvas[0].id,Canvas[1].id).toDataURL('image/png').split(',')[1]
            zip.file(Nome_Bxar(Canvas[0].id,und), imgData, {base64:true})
        })
        zip.generateAsync({type:'blob'}).then(e=>saveAs(e,'CAMISAS.zip'))
    }

    LoadDegade($('#controlCanvas'))

</script>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard do Designer — Exemplo</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#98a2b3; --accent:#7c3aed; --glass: rgba(255,255,255,0.04);
      --success:#06b6a4; --danger:#ef4444; --card-radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071024 0%, #0f1724 100%);color:#e6eef8;min-height:100vh}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}

    .grid{display:grid;gap:16px}
    .kpis{grid-template-columns:repeat(4,1fr);display:grid}
    .card{background:linear-gradient(180deg,var(--card), rgba(11,18,32,0.9));padding:14px;border-radius:var(--card-radius);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi-value{font-size:20px;font-weight:700}
    .kpi-delta{font-size:12px;color:var(--muted);margin-top:6px}

    .main{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:16px}
    .panel{background:var(--glass);padding:14px;border-radius:12px}

    .chart-wrap{display:flex;gap:12px}
    canvas{background:transparent!important}

    .list{max-height:300px;overflow:auto;margin-top:8px}
    .item{display:flex;justify-content:space-between;padding:10px 6px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}

    .small{font-size:12px}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .tag.danger{background:rgba(239,68,68,0.12);color:var(--danger)}
    .tag.success{background:rgba(6,182,164,0.08);color:var(--success)}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media (max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}.main{grid-template-columns:1fr}}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Dashboard — Perfil do Designer</h1>
        <div class="sub">Visão geral de desempenho e qualidade</div>
      </div>
      <div class="sub">Exemplo interativo • Simulação de base local</div>
    </header>

    <section class="grid">
      <div class="kpis" role="region" aria-label="Principais métricas">
        <div class="card">
          <div class="kpi-title">Interações (ocorrências do nome)</div>
          <div class="kpi-value" id="kpi-interactions">—</div>
          <div class="kpi-delta small" id="kpi-last">Última: —</div>
        </div>

        <div class="card">
          <div class="kpi-title">Valor total das artes (R$)</div>
          <div class="kpi-value" id="kpi-value">—</div>
          <div class="kpi-delta small" id="kpi-avg">Valor médio por arte: —</div>
        </div>

        <div class="card">
          <div class="kpi-title">Serviços rejeitados</div>
          <div class="kpi-value" id="kpi-rejected">—</div>
          <div class="kpi-delta small" id="kpi-rej-rate">Taxa de rejeição: —</div>
        </div>

        <div class="card">
          <div class="kpi-title">Taxa de aprovação</div>
          <div class="kpi-value" id="kpi-approval">—</div>
          <div class="kpi-delta small">Revisões médias: <span id="kpi-rev">—</span></div>
        </div>
      </div>

      <div class="main">
        <div class="panel card">
          <h3 style="margin:0 0 8px 0">Gráficos</h3>
          <div class="chart-wrap">
            <div style="flex:1">
              <canvas id="chart-earnings" height="180"></canvas>
            </div>
            <div style="width:220px">
              <canvas id="chart-approval" height="180"></canvas>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
            <div class="small muted">Filtrar por período:</div>
            <select id="period" class="small">
              <option value="all">Todos</option>
              <option value="30">Últimos 30 dias</option>
              <option value="90">Últimos 90 dias</option>
            </select>
            <button id="refresh" style="margin-left:auto;padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer">Atualizar</button>
          </div>

          <h4 style="margin-top:12px">Atividades recentes</h4>
          <div class="list" id="recent-list" aria-live="polite"></div>
        </div>

        <aside class="panel card">
          <h4 style="margin:0 0 8px 0">Resumo rápido</h4>
          <div class="muted small">Top clientes</div>
          <div id="top-clients" style="margin-top:8px"></div>

          <div style="margin-top:12px">
            <div class="muted small">Categorias mais trabalhadas</div>
            <div id="top-categories" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px">
            <div class="muted small">Serviços rejeitados (últimos)</div>
            <table id="rejected-table">
              <thead><tr><th>Data</th><th>Cliente</th><th>Valor</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:12px;text-align:center">
            <button id="export-csv" class="small" style="padding:8px 10px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer">Exportar CSV</button>
          </div>
        </aside>
      </div>
    </section>

    <footer>
      Dados simulados localmente a partir da constante <code>FakeDB</code>. Substitua depois pelo retorno real da API.
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ----- Simulação de uma "base de dados" local -----
    const FakeDB = {
      designers: [
        {
          nome: 'João',
          artes: [
            {cliente:'Acme', categoria:'Logo', valor:250, status:'approved', revisoes:0, data:'2025-09-10'},
            {cliente:'Beta', categoria:'Banner', valor:120, status:'rejected', revisoes:2, data:'2025-09-12'},
            {cliente:'Acme', categoria:'Social', valor:90, status:'approved', revisoes:1, data:'2025-09-15'},
            {cliente:'Delta', categoria:'Logo', valor:400, status:'approved', revisoes:0, data:'2025-10-01'},
            {cliente:'Gamma', categoria:'Flyer', valor:80, status:'rejected', revisoes:3, data:'2025-10-06'},
            {cliente:'Beta', categoria:'Banner', valor:150, status:'approved', revisoes:1, data:'2025-10-10'},
            {cliente:'Acme', categoria:'Social', valor:75, status:'approved', revisoes:0, data:'2025-10-12'}
          ]
        },
        {
          nome: 'Maria',
          artes: [
            {cliente:'Zeta', categoria:'Flyer', valor:200, status:'approved', revisoes:1, data:'2025-09-20'},
            {cliente:'Omega', categoria:'Logo', valor:350, status:'approved', revisoes:0, data:'2025-09-25'},
            {cliente:'Alpha', categoria:'Banner', valor:180, status:'rejected', revisoes:2, data:'2025-10-05'}
          ]
        }
      ]
    };

    // ----- Função de leitura simulada -----
    function getDesignerData(nome){
      const designer = FakeDB.designers.find(d => d.nome === nome);
      if(!designer) return [];
      return designer.artes.map(a => ({...a, designer: designer.nome}));
    }

    // ----- Configuração do dashboard -----
    const designerName = 'João';
    const data = getDesignerData(designerName);

    const fmt = v => typeof v === 'number' ? v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) : v;

    const el = id => document.getElementById(id);
    const parseDate = s => new Date(s);

    function computeMetrics(records){
      const interactions = records.length;
      const totalValue = records.reduce((s,r)=>s + (Number(r.valor)||0),0);
      const approved = records.filter(r => r.status === 'approved').length;
      const rejected = records.filter(r => r.status === 'rejected').length;
      const avgRevisions = records.length ? (records.reduce((s,r)=>s + (r.revisoes||0),0)/records.length) : 0;
      const approvalRate = records.length ? Math.round((approved/records.length)*100) : 0;
      const last = records.length ? records.reduce((a,b)=> parseDate(a.data) > parseDate(b.data) ? a : b).data : '—';
      return {records,interactions,totalValue,approved,rejected,avgRevisions,approvalRate,last};
    }

    let earningsChart, approvalChart;
    function createCharts(){
      const ctxE = document.getElementById('chart-earnings').getContext('2d');
      earningsChart = new Chart(ctxE, {
        type:'bar',
        data:{labels:[],datasets:[{label:'Ganhos (R$)',data:[],backgroundColor:'#7c3aed'}]},
        options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#cbd5e1'}},y:{ticks:{color:'#cbd5e1'}}}}
      });

      const ctxA = document.getElementById('chart-approval').getContext('2d');
      approvalChart = new Chart(ctxA, {
        type:'doughnut',
        data:{labels:['Aprovadas','Rejeitadas'],datasets:[{data:[0,0],backgroundColor:['#06b6a4','#ef4444']}]},
        options:{plugins:{legend:{position:'bottom',labels:{color:'#cbd5e1'}}}}
      });
    }

    function updateCharts(records){
      const byDay = {};
      records.forEach(r=>{
        const key = new Date(r.data).toLocaleDateString();
        byDay[key] = (byDay[key]||0) + Number(r.valor||0);
      });
      const labels = Object.keys(byDay).sort((a,b)=> new Date(a)-new Date(b));
      earningsChart.data.labels = labels;
      earningsChart.data.datasets[0].data = labels.map(l=>byDay[l]);
      earningsChart.update();

      const approved = records.filter(r=> r.status==='approved').length;
      const rejected = records.filter(r=> r.status==='rejected').length;
      approvalChart.data.datasets[0].data = [approved,rejected];
      approvalChart.update();
    }

    function render(records){
      const {records:recs,interactions,totalValue,approved,rejected,avgRevisions,approvalRate,last} = computeMetrics(records);
      el('kpi-interactions').textContent = interactions;
      el('kpi-last').textContent = 'Última: ' + (last === '—' ? '—' : new Date(last).toLocaleDateString());
      el('kpi-value').textContent = 'R$ ' + fmt(totalValue);
      el('kpi-avg').textContent = 'R$ ' + fmt(recs.length ? (totalValue / recs.length) : 0);
      el('kpi-rejected').textContent = rejected;
      el('kpi-rej-rate').textContent = recs.length ? Math.round((rejected/recs.length)*100) + '%' : '—';
      el('kpi-approval').textContent = approvalRate + '%';
      el('kpi-rev').textContent = avgRevisions.toFixed(2);

      const list = el('recent-list'); list.innerHTML = '';
      recs.slice().sort((a,b)=> new Date(b.data) - new Date(a.data)).slice(0,8).forEach(r => {
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div><strong>${r.categoria}</strong><div class="muted small">${r.cliente} • ${new Date(r.data).toLocaleDateString()}</div></div><div style="text-align:right"><div>R$ ${fmt(r.valor)}</div><div class="small">${r.status==='approved'?'<span class="tag success">Aprovado</span>':'<span class="tag danger">Rejeitado</span>'}</div></div>`;
        list.appendChild(div);
      });

      const clients = {};
      recs.forEach(r=> clients[r.cliente] = (clients[r.cliente]||0) + 1);
      el('top-clients').innerHTML = Object.entries(clients).sort((a,b)=>b[1]-a[1]).slice(0,3).map(t=> `<div class="small">${t[0]} <span class="muted">(${t[1]} jobs)</span></div>`).join('') || '<div class="muted small">—</div>';

      const cats = {};
      recs.forEach(r=> cats[r.categoria] = (cats[r.categoria]||0) + 1);
      el('top-categories').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,5).map(t=> `<div class="small">${t[0]} <span class="muted">(${t[1]})</span></div>`).join('') || '<div class="muted small">—</div>';

      const tbody = document.querySelector('#rejected-table tbody'); tbody.innerHTML = '';
      recs.filter(r=> r.status==='rejected').sort((a,b)=> new Date(b.data)-new Date(a.data)).slice(0,6).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.data).toLocaleDateString()}</td><td>${r.cliente}</td><td>R$ ${fmt(r.valor)}</td>`;
        tbody.appendChild(tr);
      });

      updateCharts(recs);
    }

    createCharts();
    render(data);

    document.getElementById('refresh').addEventListener('click', () => {
  const period = document.getElementById('period').value;
  if (period === 'all') { render(data); return; }
  const days = Number(period);
  const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
  render(data.filter(r => new Date(r.data) >= cutoff));
});

document.getElementById('export-csv').addEventListener('click', () => exportCSV(data));

// Export CSV util
function exportCSV(records) {
  const headers = ['designer','cliente','categoria','valor','status','revisoes','data'];
  const rows = records.map(r =>
    headers.map(h => {
      // tentar mapear chaves alternativas (por causa da simulação)
      const val = h === 'designer' ? (r.designer || designerName) : (r[h] ?? r[h === 'revisoes' ? 'revisoes' : h] ?? '');
      return `"${String(val).replace(/"/g, '""')}"`;
    }).join(',')
  );
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${designerName}-report.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Função auxiliar: simula adicionar nova arte à FakeDB e re-renderiza
function simulateAddArt(newArt) {
  const d = FakeDB.designers.find(x => x.nome === designerName);
  if (!d) return;
  d.artes.push(newArt);
  // atualizar a variável 'data' usada pelo dashboard
  const updated = getDesignerData(designerName);
  // sobrescreve a referência global 'data' e re-render
  window.data = updated;
  render(updated);
}

// Exemplo de uso da simulateAddArt (descomente para testar):
// simulateAddArt({cliente:'NovaCo', categoria:'Poster', valor:120, status:'approved', revisoes:0, data: new Date().toISOString().slice(0,10)});

// fecha o script e o HTML (se necessário no arquivo original)
</script>
</body>
</html>


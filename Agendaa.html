<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda</title>
    <link rel="icon" type="image/x-icon" href="Img/FavG_32.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link  href="https://raw.githack.com/InfinityGraff/MyBiblioteca/main/fontes.css"        rel="stylesheet">
    <link  href="https://raw.githack.com/InfinityGraff/MyBiblioteca/main/CSSBiblioteca.css" rel="stylesheet">
    <script src="https://raw.githack.com/InfinityGraff/MyBiblioteca/main/PreScript.js"      ></script>
    <link  href="./CssGRAFF.css" rel="stylesheet">
    <script src="./BaseGRAFF.js"></script>
    <script src="./BiblGRAFF.js"></script>
    <script src="./Gera3D.js"></script>
</head>

<script>
    const SUPABASE_URL      = "https://adxigvfxtafvlmpvwwvb.supabase.co"
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkeGlndmZ4dGFmdmxtcHZ3d3ZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1Njc1NTEsImV4cCI6MjA2NzE0MzU1MX0.wc90qDuSNhtolJBd4qLEux3xCwJwPuTTFb3gZMKUBYU"
    const supaBASE          = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY)
    const BASE_URL          = `https://adxigvfxtafvlmpvwwvb.supabase.co/storage/v1/object/public/uploads/`
</script>

<style>
    body{padding:20px}
    #Agnda{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
    #Agnda .box{padding: 3px; min-height: 100px ; min-width: 150px}
    .evt{color:#fff;margin:2px 0;padding:2px}
    .Cov:hover{background-color: #8b8b8b5d}
    .Off{opacity: 0.3}
    option.Off{color: red !important}
    .bandj{width:500px;left:50%;transform:translateX(-50%);top: 35px;}
    .bandj :is(input,select){width: 100px}
</style>

<script> // ====== BASE DE DADOS ======
    let hoje = new Date(), ano=hoje.getFullYear(), mes=hoje.getMonth(), AGND=[], DaySel=null
    const FUNC_COLOR = {Arte:'#6f42c1','Aplicação':'#0d6efd'}
    const FUNC_TIME  = {Arte:120,'Aplicação':60}
    const HORAS      = ["Hora","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"]
</script>

<script> // ====== BIBLIOTECA ======
    const LmtUser=(Arr,{Data,User})=>Arr.filter(e=>e.Data==Data && e.User==User).length>=5
    const FmtDate=d=>d.toISOString().slice(0,10)
    const FmtHora=d=>`${String(d.getHours()).padStart(2,'0')}:00`
    const HoraMin=h=>+h.split(':')[0]*60
    const MinHora=m=>`${String(m/60).padStart(2,'0')}:00`
</script>

<body class="Dark CSS1 Cl Gap">
    <h1>AGENDA infinityGRAFF</h1>
    <div class="box Cl Gap"><h2 id="mes"></h2><div id="Agnda" class="w100"></div></div>
</body>

<script>
    /* ================== HORAS ================== */
    function LoadHoras(dt,sel){
        function Ocupadas(dt){
            return AGND.filter(e=>e.Data===dt).flatMap(e=>{
                let ini = HoraMin(e.Hora)
                let dur = FUNC_TIME[e.Func]||60
                return Array.from({length:dur/60},(_,i)=>MinHora(ini+i*60))})
        }
        let agora = new Date()
        let usadas = Ocupadas(dt)
        $$('option',sel).forEach(op=>{
            let h = op.value || op.innerText
            let off1 = usadas.includes(h)
            let off2 = dt==FmtDate(agora) && h<=FmtHora(agora)
            let off = off1 || off2
            op.classList.toggle('Off', off)
            op.disabled = off
        })
    }

    /* ================== CALENDÁRIO ================== */
    function Tm_Agnd(g, lista){
        const DOW = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']
        Inn(g,'') ; Inn('#mes', hoje.toLocaleString('pt-BR',{month:'long',year:'numeric'}))
        let d0 = new Date(ano,mes,1).getDay()   // Domingo = 0
        let dm = new Date(ano,mes+1,0).getDate()
        let hj = FmtDate(new Date())
        // Cabeçalho
        DOW.forEach((d,i)=>{let off = (i === 0 || i === 6) ? 'Off' : '' ; g.innerHTML += `<div class="noslt ${off}"><b>${d}</b></div>`})
        // Espaços antes do dia 1
        for(let i=0;i<d0;i++) g.innerHTML += '<div></div>'
        // Dias do mês
        for(let d=1; d<=dm; d++){
            let dt  = `${ano}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`
            let ev  = lista.filter(e=>e.Data===dt).sort((a,b)=>HoraMin(a.Hora)-HoraMin(b.Hora))
            let dow = new Date(dt).getDay()   // 0 = Dom, 6 = Sáb
            let off = dt < hj || dow == 6 || dow == 5 ? 'Off noClk' : 'Cov'
            g.innerHTML += `<div class="box ${off} Rltv" ondblclick="OpenDay(this,event,'${dt}')"><b class="noslt">${d}</b>
                ${ev.map(e=>`<div class="evt RD Hov" style="background:${FUNC_COLOR[e.Func]||'#007bff'}" onclick="EditItem(${e.id},this)">${e.Hora} • ${e.Nome} • ${e.Func}</div>`).join('')}
                <div class="bandj gap Ct Box Abslt none"></div>
            </div>`
        }
    }

    /* ================== BANDEJA ================== */
    function TplAgnd({mode='new',data={},id=null}={}){
        const Alls = `$$('input, select',Avo(this))`
        return `
            <input  class="Nome" placeholder="Nome" value="${data.Nome||''}">
            <select class="Func">${Tm_Opt(['Função','Arte','Aplicação'],data.Func)}</select>
            <select class="User">${Tm_Opt(['Usuário','Allan','Baby','Fexta'],data.User)}</select>
            <select class="Hora">${Tm_Opt(HORAS,data.Hora)}</select>
            ${mode=='edit' ? `<input type="date" class="Data" value="${data.Data}">` : ''}
            <div class="Ct Gap">
                ${mode!='edit' ? `<button onclick="SB_Inst_AGND(${Alls})                   ">Salvar</button>`
                               : `<button onclick="SB_Edit_AGND(${Alls},${id});XModal(this)">Salvar</button>
                                  <button onclick="SB_Dlet_AGND(${id})        ;XModal(this)">Excluir</button>`
            }</div>
        `
    }

    function OpenDay(Eu,ev,dt){
        if (dt < FmtDate(new Date())) return ; DaySel = dt
        None($$('.bandj'))
        const Bj = $('.bandj',Eu)
        Inn(Bj,TplAgnd())
        LoadHoras(dt,$('.Hora',Bj))
        Show(Bj)
    }

    function EditItem(id){
        let e = AGND.find(a=>a.id==id) ; if(!e) return
        MODAL(`<h2>Editar Agendamento</h2>${TplAgnd({mode:'edit',data:e,id})}`)
        LoadHoras(e.Data,$('.FModal .Hora'))
    }
</script>

<script>// ================== SUPABASE ==================
    async function getAgnd(g){let {data}=await supaBASE.from('AGND').select('*') ; AGND=data||[] ; Tm_Agnd(g,AGND)}

    async function SB_Inst_AGND(Ipnts){
        let obj={}
        Ipnts.forEach(i=>obj[i.className]=i.value)
        obj.Data = DaySel
        if(ObjVal(obj).some(v=>!v)) return alert('Preencha tudo')
        if(LmtUser(AGND,obj))       return alert('Limite diário atingido')
        await supaBASE.from('AGND').insert(obj)
        DaySel=null
        getAgnd($('#Agnda'))
    }

    async function SB_Edit_AGND(Ipnts,id){
        let obj={}
        Ipnts.forEach(i=>obj[i.className]=i.value)
        if(ObjVal(obj).some(v=>!v)) return alert('Preencha tudo')
        await supaBASE.from('AGND').update(obj).eq('id',id)
        getAgnd($('#Agnda'))
    }

    async function SB_Dlet_AGND(id){
        if(!confirm('Excluir este agendamento?')) return
        await supaBASE.from('AGND').delete().eq('id',id)
        $('.FModal')?.remove()
        getAgnd($('#Agnda'))
    }
</script>

<script>/* ================== INIT ================== */
    getAgnd($('#Agnda'))
    document.addEventListener('click',e=>{if(!e.target.closest('.bandj') && !e.target.closest('.Cov')){None($$('.bandj'))}})
    // Filtrar pra exibir cada um
    // Ocultar quando atingir Limit Diário LmtUser(AGND,obj)

    // Campo pra Presencial, Waapp, Ligação
</script>

</html>
